---
layout: post
title: The Resource Manager Configuration
subtitle: Configuration files, environment and node descriptions
category: Administration
index: 2
---
The resource manager configuration includes many files. This can be confusing so, in this article, we try to clarify the
use of every configuration file. The first configuration file is the `seducepp.conf` file which has to be located in the
`seduce_pp` directory. This file uses the
[INI&nbsp;file&nbsp;format](https://en.wikipedia.org/wiki/INI_file){:target="_blank"}:
```
[frontend]
listen = 0.0.0.0
port = 8081
public_address = my.picluster.fr

[mail]
smtp_address = smtp.gmail.com
smtp_port = 587
account = totoadmin@gmail.com
password = totoadmin_password

[db]
connection_url=mysql://pipi:DBPASSWORD@localhost/piseduce
```
The `frontend` section defines the web interface port and the public address to access to the web interface with a
domain name.

The `mail` section allows the resource manager to send emails, for example, confirmation emails to verify the email
address of the users.

The `db` section configure the database connection. Usually, the *pipi* user is defined as the database user and the
*DBPASSWORD* string has to be replaced with the password created during the database configuration.

The configuration of log files are described as follow: 
* the log configuration of the frontend, i.e., the web interface, is in the `logging-pifrontend.conf` file. These logs are
  generated by the *pifrontend* service. When the service fails to start, errors can be written in the `/var/log/syslog`
  file.
* the log configuration of the backend, which deploys the environments, is in the `logging-pitasks.conf` file. These logs are
  generated by the *pitasks* service. When the service fails to start, errors can be written in the `/var/log/syslog`
  file.
* the log configuration of the deployment testing tool, `test_deployment.py`, is in the `logging-test.conf` file.

The other configuration files are *JSON* files. There are located in the `cluster_desc` directory. The `main.json`
defines different global propeties:
```
{
    "pimaster": {
        "ip": "192.168.122.236",
        "user": "pipi"
    },  
    "switch": {
        "ip": "192.168.1.23",
        "snmp_oid": "1.3.6.1.2.1.105.1.1.1.3.1"
    },  
    "email_signup": true,
    "email_filters": [
        "@mines-nantes.fr",
        "@inria.fr",
        "@imt-atlantique.fr"
    ],  
    "comments": "WARNING: Do NOT forget the ending /",
    "env_cfg_dir": "/home/pimanager/seduce_pp/cluster_desc/environments/",
    "img_dir": "/home/pimanager/environments/"
}
```
These properties configure the resource manager as follows:
* the `pimaster ip` is the IP of the resource manager that hosts the environment images and the NFS server.
* the `pimaster user` is the SSH user required by nodes running over the NFS file system to connect to the resource
  manager.
* the `switch ip` is the IP of the switch connected to the nodes.
* the `switch snmp_oid` is the OID used to turn off and on the nodes over SNMP. The port number of the node is appended
  to this OID to target one specific node. In this example, the command to turn off the node connected to the port 8
  will be:
  ```
  snmpset -v2c -c private 192.168.1.23 1.3.6.1.2.1.105.1.1.1.3.1.8 i 2
  ```
* the `email_signup` feature authorizes users to sign in when their email address is confirmed. When `email_signup` is
  false, administrators must authorize users to sign in manually. See the
  [user&nbsp;management](/2020-04-24-user-management) guide.
* the `email_filters` limits the email addresses that can sign up to the resource manager. Administrators do
  not receive notifications about failed sign up attempts.
* the `comments` field is just a warning to keep it mind.
* the `env_cfg_dir` is the absolute path to the environment configuration file directory.
* the `img_dir` is the absolute path to the environment image directory.

The configuration files describing the cluster nodes, or cluster resources, are located in the `cluster_desc/nodes`
directory. There is one configuration file for each node. By convention, the name of the file is `node_name.json`. For
example, the file `node-10.json`:
```
{
    "name": "node-10",
    "id": "5e8fa6a1",
    "port_number": 10, 
    "ip": "192.168.1.60",
    "model": "RPI3B+",
    "public_ip": "pi10.picluster.fr",
    "public_port": "22010"
}
```
The node properties are defined as follows:
* the node `name`, by convention, is *node-port_number*. So the node 10 is connected on the port 10 of the
  switch.
* the node `id` is a hardware property that is used for the PXE boot. This value can be found with the following
  command:
```
cat /proc/cpuinfo | grep "Serial" | awk '{ print substr( $3, length($3) - 7, length($3) ) }'
```
* the `port_number` that indicates the switch port connected to the node.
* the `ip` is used to connect from the resource manager.
* the `model` describes the model of the resources. In this example, *RPI3B+* means *Raspberry Pi 3 model B+*.
* the `public_ip` and the `public_port` are communicated to users so that they can connect to their nodes.

The configuration files of environments which can be deployed by users are located in the `cluster_desc/environments`
directory. There is one configuration file for each environment. For example, the file `raspbian_buster.json`:
```
{
    "type": "default",
    "name": "raspbian_buster",
    "img_name": "2020-02-13-raspbian-buster-lite.img.gz",
    "img_size": 1849688064,
    "sector_start": 532480,
    "ssh_user": "root",
    "shell": "bash",
    "script_test": "echo 'riri\nfifi\nloulou' > /root/picsou.txt",
}
```
The environment properties are defined as follows:
* *type*: `default` for environments created from operating system images or `user` for environments creating by copying
  an existing file system. Environments generated by *Save&nbsp;Environment* actions have the `user` type.
* *name*: the name to identify the environment. This name is used in the list of environments of the deployment form.
* *img_name*: the name of the image file, for example, `2020-02-13-raspbian-buster-lite.img.gz`.
* *img_size*: the size of the uncompressed image file in bytes. This size is used to display the progress bar during the
  `env_check` deployment state.
* *sector_start*: the first sector of the second partition of the disk image. This value can be found with the `fdisk`
  utility. First, open the image file with `fdisk -u 2020-02-13-raspbian-buster-lite.img`. Then, use `p` command to
  display the partition table. The first sector of the partition is at the second line of the *Start* column (with
  fdisk&nbsp;2.31.1).
* *ssh_user*: the SSH user used by the resource manager to connect to the node in order to configure it. SSH
  keys provided by resource manager users will be also copied on this user account, most of the time, the *root* account. 
* *shell*: the shell used to execute the *init_script* defined in the deployment form.
* *script_test*: the shell commands executed by the deployment testing tool `test_deployment.py`.

These configuration files are subject to change with the evolution of the resource manager. We will do our best to keep
this documentation up-to-date.