---
layout: post
title: Offer Users New Environments
subtitle: Registering Environment Images in the Resource Manager
category: Administration
index: 3
---

When users reserve nodes from the PiSeduce resource manager, they have to choose the environment that will be deployed
on their nodes. This environment contains the operating system and, usually, additional specific packages. By default,
the PiSeduce resource manager offers only one environment: the
[Raspbian&nbsp;lite](https://www.raspberrypi.org/downloads/raspbian/){:target="_blank"} operating system without
additional package. For the most efficient use of the Raspberry cluster, administrators can register other environments
with different operating systems or additional installed packages. See this
[article](/2020-04-24-customize-environment-images) to customize an existing operating system image. The customized disk
image has to be compressed with the `gzip` utility (do not use the `-z` option of the `tar`) and located in the
environment directory defined in the `cluster_desc/main.json` file by the value of the `img_dir` key.

The registration of the new image as an environment is done by creating a *JSON* file in the `cluster_desc/environments`
directory. At the startup, the resource manager scans the files of the `environments` directory and adds properly
configured environments to the list of the user environments. Environment description files have to define the following
values :
* *type*: `default` for environments created from operating system images or `user` for environments creating by copying
  an existing file system. Environments generated by *Save&nbsp;Environment* actions have the `user` type.
* *name*: the name to identify the environment. This name is used in the list of environments of the deployment form.
* *img_name*: the name of the image file, for example, `2020-02-13-raspbian-buster-lite.img.gz`.
* *img_size*: the size of the uncompressed image file in bytes. This size is used to display the progress bar during the
  `env_check` deployment state.
* *sector_start*: the first sector of the second partition of the disk image. This value can be found with the `fdisk`
  utility. First, open the image file with `fdisk -u 2020-02-13-raspbian-buster-lite.img`. Then, use `p` command to
  display the partition table. The first sector of the partition is at the second line of the *Start* column (with
  fdisk&nbsp;2.31.1).
* *ssh_user*: the SSH user used by the resource manager to connect to the node in order to configure it. SSH
  keys provided by resource manager users will be also copied on this user account, most of the time, the *root* account. 
* *shell*: the shell used to execute the *init_script* defined in the deployment form.
* *script_test*: the shell commands executed by the deployment testing tool `test_deployment.py`.

For example, the Raspbian&nbsp;Lite environment is described as follows:
```
{
    "type": "default",
    "name": "raspbian_buster",
    "img_name": "2020-02-13-raspbian-buster-lite.img.gz",
    "img_size": 1849688064,
    "sector_start": 532480,
    "ssh_user": "root",
    "shell": "bash",
    "script_test": "echo 'riri\nfifi\nloulou' > /root/picsou.txt",
}
``` 
This file is located to `cluster_desc/environments/raspbian-lite.json`. After adding a *JSON* file in the `environments`
directory, the PiSeduce services (*pifrontend* and *pitasks*) have to be restarted.