---
layout: post
title: Using Grid5000 with the PiSeduce Resource Manager
subtitle: Servers Reservation and Management
category: Administration
index: 13
---
The PiSeduce Resource Manager is a reservation tool designed for Raspberry Pis.
It manages the user reservations and deploys the environments on the Raspberrys.
However, the resource manager can be connected to the [Grid5000
plateform](https://www.grid5000.fr/){:target="_blank"} in order to reserve
different types of servers.

To connect the resource manager to the Grid5000 infrastructure, we deploy a
piseduce_agent with a specific configuration. Then, we connect the
piseduce_webui to this agent. As the piseduce_webui interface can manage
multiple agents, the webui can manage Raspberrys, g5k servers and Iot-Lab
sensors at the same time.

To connect the agent to the Grid5000 infrastructure, we start by getting the
piseduce_agent from the github repository:
```
git clone http://github.com/remyimt/piseduce_agent
```

Then, we modify the configuration file `config_agent.json`. We change the
**auth_token** property to another string (at least 10 characters). This token
is used to secure the connection between the webui and the agent. We will need
it later. Then, we set the **node_type** property to `g5k`. The Grid5000 
testbed consists of multiple sites. One agent can manage only the site defined
by the **g5k_site** property. So, if we want to use many Grid5000 sites, we have
to deploy multiple agents. To deploy multiple agents to the same server, we have
to use a different port (**port_number** property) and a different database file
(**db_url** property).

Here, we configure one agent to manage the *nancy* site of the Grid5000
testbed. The content of our configuration file (**do not use the auth_token
defined below**) is:
```
{
    "auth_token": [ "g5ksuperlongtoken1234" ],
    "port_number": 8099,
    "comments": "Type of the nodes managed by this agent (raspberry, g5k or iot-lab)",
    "node_type": "g5k",
    "g5k_site": "nancy",
    "iot_site": "strasbourg",
    "key_file": "secret.key",
    "db_url": "sqlite:///test-g5k.db",
    "comments": "Do not forget the ending '/' at the end of the env_path",
    "env_path": "/root/environments/"
}
```

The **key_file** property defines the encryption key used to decrypt the
password of the iot-lab account. This key file is generated by the webui that
uses it to encrypt passwords. Indeed, users of the resource manager must provide
their Grid5000 account information (user and password) to reserve sensors on the
Iot-Lab infrastructure. This password is encrypted with the key file before
being stored in the database. So, we have to copy this key from the webui to the
piseduce_agent directory.

Before starting the agent API, we have to create the tables of the SQLite
database:
```
python3 init_database.py config_agent.json
```
Then, we start the agent API with the following command:
```
python3 agent_api config_agent.json
```

On the resource manager interface (with the administration privilege), we open
the agent panel by clicking on the *(admin) Agent* item of the left menu. We
fill in the *Add Agent* form with an appropriate name for the agent (e.g.,
*g5k_nancy*), the IP, the port and the token previously defined. We click on the
*Add* button and the agent should appear in the *Existing Agents* section with
the *connected* state.

The servers managed by the agent should appear in the reserve panel. To
reserve these nodes, we must register our Grid5000 username and our Grid5000
password. We open the settings panel by clicking on the *Settings* item of the
menu. On the *G5k Credentials* tab, we fill in the form to register the Grid5000
account information. Now, we can reserve servers from the reserve panel.

After making the reservation, we have to select the Grid5000 environment to
deploy on the reserved servers from the configure panel. The environment names
are explained in the [Grid5000 Getting
Started](https://www.grid5000.fr/w/Getting_Started#Deploying_nodes_with_Kadeploy){:target="_blank"}
page. We can also provide our SSH key to connect to the servers. If the SSH key
of our PiSeduce account is set, this key will be installed to the Grid5000
servers (to add a SSH key to our PiSeduce account, we open the *SSH key* tab of
the settings panel).

Finally, we click on the *Deploy* button to start the deployment. We are
redirected to the manage panel to follow the progress of the deployment. To
start the deployment process, we need to start the piseduce_agent executor:
```
python3 agent_exec.py config_agent.json
```
The agent executor reads the database and send commands to the Grid5000 API to
start the deployment.

Both agent_api.py and agent_exec.py scripts can be run as SystemD services. To
configure the services, we can run the following commnands (as root):
```
cp admin/*.service /etc/systemd/system/
systemctl enable agent_api.service
systemctl enable agent_exec.service
```
Then, we can start the agent API and the agent executor as described below:
```
service agent_api start
service agent_exec start
```

The configuration of the g5k agent is completed. PiSeduce users can now reserve
and manage g5k servers from the resource manager.

**NOTE**: Grid5000 jobs that are not created from the PiSeduce resource manager
can not be managed from the resource manager.
